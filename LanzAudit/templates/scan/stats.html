{% extends "base.html" %}

{% block title %}LanzAudit | Estadísticas{% endblock %}
{% block page_title %}Resultados y Estadísticas{% endblock %}
{% block page_title_2 %}Resultados y Estadísticas{% endblock %}

{% block content %}

<!-- Resumen de Actividad -->
<div class="col-md-12">
  <div class="card mb-4">
    <div class="card-header"><h4 class="card-title">Resumen de Actividad</h4></div>
    <div class="card-body">
      <div class="row text-center">
        <div class="col-md-3 mb-3">
          <div class="card shadow-sm">
            <div class="card-body">
              <i class="bi bi-list-check fs-2 text-primary"></i>
              <h5 class="mt-2">Total Escaneos</h5>
              <p class="h4">{{ total_scans }}</p>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card shadow-sm">
            <div class="card-body">
              <i class="bi bi-check-circle fs-2 text-success"></i>
              <h5 class="mt-2">Completados</h5>
              <p class="h4">{{ completed_scans }}</p>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card shadow-sm">
            <div class="card-body">
              <i class="bi bi-x-circle fs-2 text-danger"></i>
              <h5 class="mt-2">Fallidos</h5>
              <p class="h4">{{ failed_scans }}</p>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card shadow-sm">
            <div class="card-body">
              <i class="bi bi-clock-history fs-2 text-warning"></i>
              <h5 class="mt-2">Último Escaneo</h5>
              <p class="h6">{{ last_scan.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Puertos más Encontrados -->
<div class="col-md-12">
  <div class="card mb-4">
    <div class="card-header"><h4 class="card-title">Puertos Abiertos Más Encontrados</h4></div>
    <div class="card-body">
      <div class="row justify-content-center text-center">
        {% for port in top_ports %}
        <div class="col-md-2 mb-3">
          <div class="card shadow-sm border-0">
            <div class="card-body">
              <i class="{{ PORT_ICONS.get(port.port, 'bi bi-hdd-network') }} fs-3 text-primary"></i>
              <h6 class="mt-2">Puerto {{ port.port }} ({{ port.label }})</h6>
              <p class="h5">{{ port.count }} veces</p>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- Gráficas 
<div class="col-md-12">
  <div class="card mb-4">
    <div class="card-header"><h4 class="card-title">Distribución de Escaneos</h4></div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6 text-center">
          <canvas id="scanTypeChart" height="250" class="w-100"></canvas>
        </div>
        <div class="col-md-6 text-center">
          <canvas id="scanStatusChart" height="250" class="w-100"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>
-->
<!-- Escaneos Realizados -->
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h3 class="card-title">Escaneos Realizados</h3>
  </div>
  <div class="card-body">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="alert-container">
      {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
      </div>
      {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <table class="table table-bordered table-hover">
      <thead class="thead-dark">
        <tr>
          <th>ID</th>
          <th>IP/Host</th>
          <th>Tipo</th>
          <th>Estado</th>
          <th>Realizado por</th>
          <th>Fecha de Realización</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for scan in scans %}
        <tr>
          <td>{{ scan.id }}</td>
          <td>{{ scan.scan_parameters.get('target', '—') }}</td>
          <td>
            {% set subtype = scan.scan_parameters.get('subtype') %}
            {% if subtype == 'fast' %}
              {{ scan.scan_type }} - Rápido
            {% elif subtype == 'full' %}
              {{ scan.scan_type }} - Completo
            {% elif subtype == 'discovery' %}
              {{ scan.scan_type }} - Descubrimiento
            {% elif subtype == 'versions' %}
              {{ scan.scan_type }} - Versiones de Servicios
            {% elif subtype == 'custom' %}
              {{ scan.scan_type }} - Personalizado
            {% else %}
              {{ scan.scan_type }}
            {% endif %}
          </td>
          <td>
            {% if scan.status == 'Completado' %}
              <span class="badge bg-success">Completado</span>
            {% elif scan.status == 'Fallido' %}
              <span class="badge bg-danger">Fallido</span>
            {% endif %}
          </td>
          <td>{{ scan.user.username }}</td>
          <td>{{ scan.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
          <td>
            <a href="{{ url_for('viewScan', scan_id=scan.id) }}" class="btn btn-sm btn-link" title="Ver Detalles">
              <i class="bi bi-eye"></i>
            </a>
            {% if current_user.role == 'Admin' or current_user.id == scan.user_id %}
            <button type="button" class="btn btn-sm btn-link" data-bs-toggle="modal" data-bs-target="#deleteModal{{ scan.id }}" title="Eliminar">
              <i class="bi bi-trash"></i>
            </button>
            {% endif %}
          </td>
        </tr>

        <!-- Modal Confirmación -->
        <div class="modal fade" id="deleteModal{{ scan.id }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ scan.id }}" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel{{ scan.id }}">Confirmación de eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
              </div>
              <div class="modal-body">
                ¿Estás seguro de que quieres eliminar el escaneo con ID {{ scan.id }}?
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form method="POST" action="{{ url_for('deleteScan', scan_id=scan.id) }}">
                  <button type="submit" class="btn btn-danger">Eliminar</button>
                </form>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const scanTypeChart = new Chart(document.getElementById('scanTypeChart'), {
    type: 'doughnut',
    data: {
      labels: ['Nmap', 'WPScan'],
      datasets: [{
        label: 'Tipo de Escaneo',
        data: [{{ total_nmap }}, {{ total_wpscan }}],
        backgroundColor: ['#0d6efd', '#6610f2']
      }]
    }
  });

  const scanStatusChart = new Chart(document.getElementById('scanStatusChart'), {
    type: 'bar',
    data: {
      labels: ['Completados', 'Fallidos'],
      datasets: [{
        label: 'Estado de Escaneos',
        data: [{{ completed_scans }}, {{ failed_scans }}],
        backgroundColor: ['#198754', '#dc3545']
      }]
    },
    options: {
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
</script>
{% endblock %}
